function t(){return window.crypto?(1e7.toString()+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g,t=>{const e=parseInt(t,10);return(e^window.crypto.getRandomValues(new Uint8Array(1))[0]&15>>e/4).toString(16)}):"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(t){const e=16*Math.random()|0;return("x"===t?e:3&e|8).toString(16)}))}class e{constructor(t=window){this.target=t,this.target.__MfBrokerRetained=new Map}getTarget(){return this.target}getTargetId(){const e=this.target;return e.__MfBrokerTargetId||(e.__MfBrokerTargetId=`T-${t()}`),e.__MfBrokerTargetId}publish(t,e,r=!1){return this.publishWithTarget(this.target,t,e,r)}publishWithTarget(e,r,s,i=!1){const n={date:new Date,retain:i,id:`E-${t()}`};return this.publishCustom(e,r,n,s)}publishCustom(t,r,s,i){const n=this.target,o=e.topicAsString(r),a=new CustomEvent(o,{detail:i,bubbles:!0,cancelable:!1,composed:!0});a.detailInfo=s;const c={data:i,info:s,event:a};return s.retain&&n.__MfBrokerRetained.set(o,c),t.dispatchEvent(a),c}subscribe(t,r){const s=this.target,i=e.topicAsString(t),n=t=>{r.call(s,t.detail,t)};if(s.addEventListener(i,n,!0),s.__MfBrokerRetained){const t=s.__MfBrokerRetained.get(i);t&&r.call(s,t.data,t.event)}return{broker:this,topic:i,callback:r,unsubscribe:()=>{this.target.removeEventListener(i,n,!0)}}}getRetained(t){const r=this.target,s=e.topicAsString(t),i=r.__MfBrokerRetained.get(s);return i?Object.assign({},i):null}static getInstance(t=window){const r=t;return r.__MfBrokerInstance||(r.__MfBrokerInstance=new e(t)),r.__MfBrokerInstance}static topicAsString(t){return Array.isArray(t)&&(t=t.join(":")),t}}class r{constructor(t,e=null){this.broker=t,this.acceptedOrigins=e,this.targetWindow=t.getTarget(),this.acceptedOrigins||(this.acceptedOrigins=[t.getTarget().location.origin]),this.getTargetId(),this.initEventPropagationListener()}getTarget(){return this.targetWindow}getTargetId(){return this.broker.getTargetId()}publish(r,s,i=!1){const n=e.topicAsString(r),o=this.broker.publish(n,s,i),a=this.targetWindow;return this.requestEventPropagation({senderId:a.__MfBrokerTargetId,id:`M-${t()}`,topic:n,info:o.info,data:o.data}),o}subscribe(t,e){return this.broker.subscribe(t,e)}getRetained(t){return this.broker.getRetained(t)}initEventPropagationListener(){const t=this.targetWindow;t.__MfFramesetBrokerHasListener||(t.addEventListener("message",t=>{if(this.acceptedOrigins.includes(t.origin)){const e=t.data;this.isFramesetBrokerMessage(e)&&!this.isSentFromCurrentTarget(e)&&(this.propagateIntoCurrentTarget(e),this.propagateToChildsTargets(e,t.origin))}}),t.__MfFramesetBrokerHasListener=!0)}isFramesetBrokerMessage(t){return t.senderId&&t.id&&t.info&&t.data}isSentFromCurrentTarget(t){const e=this.getTargetId();return t.senderId===e}requestEventPropagation(t,e=this.targetWindow.location.origin){const r=this.targetWindow.top;r&&r!==this.targetWindow&&r.postMessage(t,e),this.propagateToChildsTargets(t,e)}getChildsTargets(){const t=[...Array.from(this.targetWindow.document.querySelectorAll("frame")),...Array.from(this.targetWindow.document.querySelectorAll("iframe"))],e=[];for(const r of t)r.contentWindow&&e.push(r.contentWindow);return e}propagateIntoCurrentTarget(t){this.broker.publishCustom(this.targetWindow,t.topic,t.info,t.data)}propagateToChildsTargets(t,e){this.getChildsTargets().forEach(r=>{r.postMessage(t,e)})}static getInstance(t){const e=t.getTarget();return e.__MfFramesetBrokerInstance||(e.__MfFramesetBrokerInstance=new r(t)),e.__MfFramesetBrokerInstance}}function s(t,e,r,s){return new(r||(r=Promise))((function(i,n){function o(t){try{c(s.next(t))}catch(t){n(t)}}function a(t){try{c(s.throw(t))}catch(t){n(t)}}function c(t){var e;t.done?i(t.value):(e=t.value,e instanceof r?e:new r((function(t){t(e)}))).then(o,a)}c((s=s.apply(t,e||[])).next())}))}class i{constructor(t,e=5e3){this.broker=t,this.responseTimeout=e,this.registeredCallbacks=new Map,this.targetWindow=t.getTarget(),this.getTargetId(),this.initProcedureRequestListener()}setReponseTimeout(t){this.responseTimeout=t}getTarget(){return this.targetWindow}getTargetId(){return this.broker.getTargetId()}register(t,e){this.registeredCallbacks.set(t,e)}getCallback(t){return this.registeredCallbacks.get(t)}call(e,...r){const s={id:t(),name:e,args:r,resolved:!1},i=this.getCallback(s.name);return i?this.applyCallback(s,i):new Promise((t,r)=>{let i=null;const n=this.broker.subscribe(`mf:proc:res:${s.id}`,e=>{n.unsubscribe(),window.clearTimeout(i),t(e.result)});i=window.setTimeout(()=>{n.unsubscribe(),r(new Error(`Procedure request timeout (${this.responseTimeout}) for callback with name "${e}"`))},this.responseTimeout),this.broker.publish("mf:proc:req",s,!1)})}initProcedureRequestListener(){const t=this.targetWindow;t.__MfProcedureBrokerHasListener||(this.subscription=this.broker.subscribe("mf:proc:req",t=>s(this,void 0,void 0,(function*(){const e=this.getCallback(t.name);if(e){const r=yield this.applyCallback(t,e),s={id:t.id,name:t.name,result:r};this.broker.publish(`mf:proc:res:${t.id}`,s,!1)}}))),t.__MfProcedureBrokerHasListener=!0)}applyCallback(t,e){return s(this,void 0,void 0,(function*(){let r=e(...t.args);return t.resolved=!0,r instanceof Promise&&(r=yield r),r}))}static getInstance(t,e){const r=t.getTarget();return r.__MfProcedureBrokerInstance||(r.__MfProcedureBrokerInstance=new i(t,e)),r.__MfProcedureBrokerInstance}}export{e as Broker,r as FramesetBroker,i as ProcedureBroker};
//# sourceMappingURL=index.js.map

var t,e=new Uint8Array(16);function r(){if(!t&&!(t="undefined"!=typeof crypto&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto)||"undefined"!=typeof msCrypto&&"function"==typeof msCrypto.getRandomValues&&msCrypto.getRandomValues.bind(msCrypto)))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return t(e)}var s=/^(?:[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}|00000000-0000-0000-0000-000000000000)$/i;function i(t){return"string"==typeof t&&s.test(t)}for(var n=[],o=0;o<256;++o)n.push((o+256).toString(16).substr(1));function a(t,e,s){var o=(t=t||{}).random||(t.rng||r)();if(o[6]=15&o[6]|64,o[8]=63&o[8]|128,e){s=s||0;for(var a=0;a<16;++a)e[s+a]=o[a];return e}return function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,r=(n[t[e+0]]+n[t[e+1]]+n[t[e+2]]+n[t[e+3]]+"-"+n[t[e+4]]+n[t[e+5]]+"-"+n[t[e+6]]+n[t[e+7]]+"-"+n[t[e+8]]+n[t[e+9]]+"-"+n[t[e+10]]+n[t[e+11]]+n[t[e+12]]+n[t[e+13]]+n[t[e+14]]+n[t[e+15]]).toLowerCase();if(!i(r))throw TypeError("Stringified UUID is invalid");return r}(o)}class c{constructor(t=window){this.target=t;this.target.__MfBrokerRetained=new Map}getTarget(){return this.target}getTargetId(){const t=this.target;return t.__MfBrokerTargetId||(t.__MfBrokerTargetId=`T-${a()}`),t.__MfBrokerTargetId}publish(t,e,r=!1){return this.publishWithTarget(this.target,t,e,r)}publishWithTarget(t,e,r,s=!1){const i={date:new Date,retain:s,id:`E-${a()}`};return this.publishCustom(t,e,i,r)}publishCustom(t,e,r,s){const i=this.target,n=c.topicAsString(e),o=new CustomEvent(n,{detail:s,bubbles:!0,cancelable:!1,composed:!0});o.detailInfo=r;const a={data:s,info:r,event:o};return r.retain&&i.__MfBrokerRetained.set(n,a),t.dispatchEvent(o),a}subscribe(t,e){const r=this.target,s=c.topicAsString(t),i=t=>{e.call(r,t.detail,t)};if(r.addEventListener(s,i,!0),r.__MfBrokerRetained){const t=r.__MfBrokerRetained.get(s);t&&setTimeout((()=>{e.call(r,t.data,t.event)}),0)}return{broker:this,topic:s,callback:e,unsubscribe:()=>{this.target.removeEventListener(s,i,!0)}}}getRetained(t){const e=this.target,r=c.topicAsString(t),s=e.__MfBrokerRetained.get(r);return s?Object.assign({},s):null}static getInstance(t=window){const e=t;return e.__MfBrokerInstance||(e.__MfBrokerInstance=new c(t)),e.__MfBrokerInstance}static topicAsString(t){return Array.isArray(t)&&(t=t.join(":")),t}}class u{constructor(t,e=null){this.broker=t,this.acceptedOrigins=e,this.targetWindow=t.getTarget(),this.acceptedOrigins||(this.acceptedOrigins=[t.getTarget().location.origin]),this.getTargetId(),this.initEventPropagationListener()}getTarget(){return this.targetWindow}getTargetId(){return this.broker.getTargetId()}publish(t,e,r=!1){const s=c.topicAsString(t),i=this.broker.publish(s,e,r),n=this.targetWindow;return this.requestEventPropagation({senderId:n.__MfBrokerTargetId,id:`M-${a()}`,topic:s,info:i.info,data:i.data}),i}subscribe(t,e){return this.broker.subscribe(t,e)}getRetained(t){return this.broker.getRetained(t)}initEventPropagationListener(){const t=this.targetWindow;t.__MfFramesetBrokerHasListener||(t.addEventListener("message",(t=>{if(this.acceptedOrigins.includes(t.origin)){const e=t.data;this.isFramesetBrokerMessage(e)&&!this.isSentFromCurrentTarget(e)&&(this.propagateIntoCurrentTarget(e),this.propagateToChildsTargets(e,t.origin))}})),t.__MfFramesetBrokerHasListener=!0)}isFramesetBrokerMessage(t){return t.senderId&&t.id&&t.info&&t.data}isSentFromCurrentTarget(t){const e=this.getTargetId();return t.senderId===e}requestEventPropagation(t,e=this.targetWindow.location.origin){const r=this.targetWindow.top;r&&r!==this.targetWindow&&r.postMessage(t,e),this.propagateToChildsTargets(t,e)}getChildsTargets(){const t=[...Array.from(this.targetWindow.document.querySelectorAll("frame")),...Array.from(this.targetWindow.document.querySelectorAll("iframe"))],e=[];for(const r of t)r.contentWindow&&e.push(r.contentWindow);return e}propagateIntoCurrentTarget(t){this.broker.publishCustom(this.targetWindow,t.topic,t.info,t.data)}propagateToChildsTargets(t,e){this.getChildsTargets().forEach((r=>{r.postMessage(t,e)}))}static getInstance(t){const e=t.getTarget();return e.__MfFramesetBrokerInstance||(e.__MfFramesetBrokerInstance=new u(t)),e.__MfFramesetBrokerInstance}}function g(t,e,r,s){return new(r||(r=Promise))((function(i,n){function o(t){try{c(s.next(t))}catch(t){n(t)}}function a(t){try{c(s.throw(t))}catch(t){n(t)}}function c(t){var e;t.done?i(t.value):(e=t.value,e instanceof r?e:new r((function(t){t(e)}))).then(o,a)}c((s=s.apply(t,e||[])).next())}))}class d{constructor(t,e=5e3){this.broker=t,this.responseTimeout=e,this.registeredCallbacks=new Map,this.targetWindow=t.getTarget(),this.getTargetId(),this.initProcedureRequestListener()}setReponseTimeout(t){this.responseTimeout=t}getTarget(){return this.targetWindow}getTargetId(){return this.broker.getTargetId()}register(t,e){this.registeredCallbacks.set(t,e)}getCallback(t){return this.registeredCallbacks.get(t)}call(t,...e){const r={id:a(),name:t,args:e,resolved:!1},s=this.getCallback(r.name);return s?this.applyCallback(r,s):new Promise(((e,s)=>{let i=null;const n=this.broker.subscribe(`mf:proc:res:${r.id}`,(t=>{n.unsubscribe(),window.clearTimeout(i),e(t.result)}));i=window.setTimeout((()=>{n.unsubscribe(),s(new Error(`Procedure request timeout (${this.responseTimeout}) for callback with name "${t}"`))}),this.responseTimeout),this.broker.publish("mf:proc:req",r,!1)}))}initProcedureRequestListener(){const t=this.targetWindow;t.__MfProcedureBrokerHasListener||(this.subscription=this.broker.subscribe("mf:proc:req",(t=>g(this,void 0,void 0,(function*(){const e=this.getCallback(t.name);if(e){const r=yield this.applyCallback(t,e),s={id:t.id,name:t.name,result:r};this.broker.publish(`mf:proc:res:${t.id}`,s,!1)}})))),t.__MfProcedureBrokerHasListener=!0)}applyCallback(t,e){return g(this,void 0,void 0,(function*(){let r=e(...t.args);return t.resolved=!0,r instanceof Promise&&(r=yield r),r}))}static getInstance(t,e){const r=t.getTarget();return r.__MfProcedureBrokerInstance||(r.__MfProcedureBrokerInstance=new d(t,e)),r.__MfProcedureBrokerInstance}}export{c as Broker,u as FramesetBroker,d as ProcedureBroker};
//# sourceMappingURL=index.js.map

<!DOCTYPE html>
<html>
  <head>
    <title>mf-broker Demo</title>
    <style type="text/css"> @import url("./demo-style.css"); </style>
  </head>
  <body>
    <div id="cnt">
      <div id="btns">
        <button id="subscribe">Subscribe</button>
        <button id="publish">Publish</button>
        <button id="publishr">Publish Retain</button>
        <button id="retained">Retained</button>
        <button id="proc1">Call Procedure "1"</button>
        <button id="proc-double">Call Procedure "double"</button>
        <button id="proc-error">Call Procedure "get-error"</button>
        <button id="proc2">Call Undefined Procedure</button>
        &nbsp;&nbsp;&nbsp;&nbsp;
        <a href="./index-frame.html">GO to Frameset Broker Demo</a>
      </div>
    </div>
    <script type="module">
      import { Broker, ProcedureBroker } from "./esm/index.js";

      const broker     = Broker.getInstance();
      const procBroker = ProcedureBroker.getInstance(broker, 1000);

      window.broker     = broker;
      window.procBroker = procBroker;

      procBroker.register("proc1", (...args) => {
        return JSON.stringify(args, null, 2);
      });

      procBroker.register("double", (num) => {
        return num * 2;
      });

      procBroker.register("get-error", async (num) => {
        throw new Error("Errored procedure");
      });

      document.querySelector("#publish").addEventListener("click", function() {
        const data = {
          foo: "bar",
          rand: Math.random()
        };
        console.log("publish -> data:", data);
        broker.publish("test:topic", data);
      });

      document.querySelector("#publishr").addEventListener("click", function() {
        const data = {
          foo: "retained",
          rand: Math.random()
        };
        console.log("publish retain -> data:", data);
        broker.publish("test:topic", data, true);
      });

      document.querySelector("#subscribe").addEventListener("click", function() {
        console.log("subscribed to topic");
        broker.subscribe(["test", "topic"], (data, event) => {
          console.log("data -> subcription:", data, "info", event.detailInfo, "event", event);
        });
      });

      document.querySelector("#retained").addEventListener("click", function() {
        console.log("retained -> data:", broker.getRetained("test:topic"));
      });

      document.querySelector("#proc1").addEventListener("click", function() {
        procBroker.call("proc1", "foo", 123).then((result) => {
          console.log("proc1 result: ", result);
        })
      });

      document.querySelector("#proc-double").addEventListener("click", function() {
        procBroker.call("double", 32).then((result) => {
          console.log("double of 32: ", result);
        })
      });

      document.querySelector("#proc-error").addEventListener("click", function() {
        procBroker.call("get-error",).catch((err) => {
          console.log("get-error result: ", err);
        });
      });

      document.querySelector("#proc2").addEventListener("click", function() {
        procBroker.call("proc2", "foo", 123).catch((err) => {
          console.log("proc2 error: ", err);
        });
      });

    </script>
    <style type="text/css"> @import url("./console-style.css"); </style>
    <script type="application/javascript" src="//cdn.rawgit.com/Alorel/console-log-html/master/console-log-html.min.js"></script>
    <script type="application/javascript" src="./console-config.js"></script>
  </body>
</html>
